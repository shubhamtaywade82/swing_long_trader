# Order Placement Policy

## Overview

This document describes the order placement policy for the swing trading system. **All orders must use LIMIT orders - MARKET orders are never used.**

## Policy: LIMIT Orders Only

### Entry Orders

- **Order Type**: Always `LIMIT`
- **Price**: Uses `entry_price` from the trade plan/signal
- **Rationale**: 
  - Prevents slippage
  - Ensures entry at planned price
  - Better price control for swing trading

**Example:**
```ruby
Dhan::Orders.place_order(
  instrument: instrument,
  order_type: "LIMIT",
  transaction_type: "BUY",
  quantity: 100,
  price: entry_price, # From trade plan
)
```

### Exit Orders

- **Order Type**: Always `LIMIT`
- **Price**: Uses current LTP (Last Traded Price) from Redis cache
- **Rationale**:
  - Ensures exit at current market price
  - Prevents slippage on exits
  - Better execution control

**Example:**
```ruby
current_ltp = instrument.current_ltp
Dhan::Orders.place_order(
  instrument: instrument,
  order_type: "LIMIT",
  transaction_type: "SELL",
  quantity: position.quantity,
  price: current_ltp, # Current market price
)
```

## Implementation

### Entry Order Placement

**File**: `app/services/strategies/swing/executor.rb`

```ruby
def place_entry_order
  # Always use LIMIT orders
  order_type = "LIMIT"
  limit_price = @signal[:entry_price]
  
  Dhan::Orders.place_order(
    instrument: @instrument,
    order_type: order_type,
    transaction_type: transaction_type,
    quantity: @signal[:qty],
    price: limit_price, # LIMIT order with entry price
  )
end
```

### Exit Order Placement

**File**: `app/jobs/strategies/swing/exit_monitor_job.rb`

```ruby
def place_exit_order_for_position(position, _reason)
  # Get current LTP for LIMIT order price
  current_ltp = position.instrument.current_ltp
  
  Dhan::Orders.place_order(
    instrument: position.instrument,
    order_type: "LIMIT",
    transaction_type: exit_transaction_type,
    quantity: position.quantity,
    price: current_ltp, # LIMIT order with current LTP
  )
end
```

## Why LIMIT Orders?

1. **Price Control**: Ensures orders execute at planned prices
2. **Slippage Prevention**: Avoids unexpected execution prices
3. **Risk Management**: Better control over entry/exit prices
4. **Swing Trading Best Practice**: LIMIT orders are standard for swing trading

## Error Handling

If LTP is not available for exit orders:

```ruby
current_ltp = position.instrument.current_ltp
unless current_ltp&.positive?
  return {
    success: false,
    error: "Current LTP not available for exit LIMIT order",
  }
end
```

## Trade Plan Integration

Trade plans generated by `Screeners::TradePlanBuilder` include:
- `entry_price`: Used as LIMIT price for entry orders
- `stop_loss`: Used for stop-loss monitoring
- `take_profit`: Used for take-profit monitoring

The executor uses `entry_price` directly as the LIMIT order price.

## Notes

- **Never use MARKET orders** - All order placement code enforces LIMIT orders
- Entry orders use `entry_price` from trade plan
- Exit orders use current LTP from Redis cache
- If LTP is unavailable, exit order placement fails gracefully
