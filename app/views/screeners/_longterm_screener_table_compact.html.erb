<%# SCREENER CONTRACT: Compact mode for Recommendations tab - focused on actionable accumulation plan data %>
<% show_recommendation = local_assigns.fetch(:show_recommendation, false) %>
<% show_position = local_assigns.fetch(:show_position, false) %>
<% compact_mode = local_assigns.fetch(:compact_mode, true) %>

<div class="card">
  <div class="card-body p-2">
    <% if compact_mode && show_recommendation %>
      <!-- Compact mode for Recommendations tab - focused on accumulation info -->
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0 screener-table" id="longterm-screener-results-table">
          <thead>
            <tr>
              <th class="sortable text-right" data-sort="rank" data-sort-type="number">#</th>
              <th class="sortable" data-sort="symbol" data-sort-type="string">Symbol</th>
              <th class="sortable text-right" data-sort="score" data-sort-type="number">Score</th>
              <th class="sortable" data-sort="setup_status" data-sort-type="string">Setup Status</th>
              <th class="sortable text-right" data-sort="price" data-sort-type="number">Price</th>
              <th class="sortable text-right" data-sort="buy_zone" data-sort-type="number">Buy Zone</th>
              <th class="sortable text-right" data-sort="invalid" data-sort-type="number">Invalid Level</th>
              <th class="sortable text-right" data-sort="allocation" data-sort-type="number">Allocation %</th>
              <th class="sortable text-right" data-sort="allocation_amount" data-sort-type="number">Allocation ₹</th>
              <th class="sortable text-right" data-sort="horizon" data-sort-type="number">Horizon</th>
              <% has_ai_data = candidates.any? { |c| c[:ai_score] || c[:ai_confidence] } %>
              <% if has_ai_data %>
                <th class="sortable text-right" data-sort="ai_confidence" data-sort-type="number">AI Confidence</th>
              <% end %>
              <th class="sortable" data-sort="recommendation" data-sort-type="string">Recommendation</th>
            </tr>
          </thead>
          <tbody data-screener-results="true" data-screener-type="longterm">
            <% candidates.each_with_index do |candidate, index| %>
              <% price = candidate.dig(:daily_indicators, :latest_close) || candidate.dig(:weekly_indicators, :latest_close) || 0 %>
              <% accumulation_plan = candidate[:accumulation_plan] %>
              <% setup_status = candidate[:setup_status] || "UNKNOWN" %>
              <% weekly_adx = candidate.dig(:weekly_indicators, :adx) %>
              <% daily_rsi = candidate.dig(:daily_indicators, :rsi) %>
              <%
                instrument_key = nil
                if candidate[:instrument_id]
                  instrument = Instrument.find_by(id: candidate[:instrument_id])
                  instrument_key = instrument ? "#{instrument.exchange_segment}:#{instrument.security_id}" : nil
                end
              %>
              <tr data-screener-symbol="<%= candidate[:symbol] %>"
                  data-screener-instrument-id="<%= candidate[:instrument_id] %>"
                  <% if instrument_key %>
                    data-instrument-key="<%= instrument_key %>"
                  <% end %>
                  data-rank="<%= index + 1 %>"
                  data-symbol="<%= candidate[:symbol] %>"
                  data-score="<%= candidate[:score] || 0 %>"
                  data-setup-status="<%= setup_status %>"
                  data-price="<%= price %>"
                  <% if accumulation_plan %>
                  data-buy-zone="<%= accumulation_plan[:buy_zone] || 0 %>"
                  data-invalid="<%= accumulation_plan[:invalid_level] || 0 %>"
                  data-allocation="<%= accumulation_plan[:allocation_pct] || 0 %>"
                  data-allocation-amount="<%= accumulation_plan[:allocation_amount] || 0 %>"
                  data-horizon="<%= accumulation_plan[:time_horizon] || 0 %>"
                  <% end %>
                  data-ai-confidence="<%= candidate[:ai_confidence] || 0 %>"
                  data-recommendation="<%= candidate[:recommendation] || '' %>">
                <td class="text-right"><strong>#<%= index + 1 %></strong></td>
                <td><strong><%= candidate[:symbol] %></strong></td>
                <td class="text-right">
                  <span class="badge bg-<%= candidate[:score] >= 70 ? 'success' : candidate[:score] >= 50 ? 'warning' : 'secondary' %>">
                    <%= number_with_precision(candidate[:score], precision: 1) %>
                  </span>
                </td>
                <td>
                  <% setup_class = case setup_status
                       when "ACCUMULATE" then "success"
                       when "WAIT_DIP", "WAIT_BREAKOUT" then "warning"
                       when "IN_POSITION" then "info"
                       else "secondary"
                     end %>
                  <span class="badge bg-<%= setup_class %>" title="<%= candidate[:setup_reason] || '' %>">
                    <%= setup_status.gsub('_', ' ') %>
                  </span>
                </td>
                <td class="text-right js-ltp-cell" data-price-cell="true" <% if instrument_key %>data-instrument-key="<%= instrument_key %>"<% end %>>
                  <strong>₹<%= number_with_precision(price, precision: 2) %></strong>
                </td>
                <%# SCREENER CONTRACT: Recommendations tab shows actionable accumulation plan data %>
                <td class="text-right">
                  <% if accumulation_plan %>
                    <strong>₹<%= accumulation_plan[:buy_zone] %></strong>
                    <% if accumulation_plan[:add_on_zones]&.any? %>
                      <small class="text-muted d-block" style="font-size: 0.7rem;">
                        +<%= accumulation_plan[:add_on_zones].size %> add-ons
                      </small>
                    <% end %>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td class="text-right">
                  <% if accumulation_plan %>
                    <span class="badge bg-danger">₹<%= number_with_precision(accumulation_plan[:invalid_level], precision: 2) %></span>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td class="text-right">
                  <% if accumulation_plan %>
                    <strong><%= number_with_precision(accumulation_plan[:allocation_pct], precision: 1) %>%</strong>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td class="text-right">
                  <% if accumulation_plan && accumulation_plan[:allocation_amount] && accumulation_plan[:allocation_amount] > 0 %>
                    <strong>₹<%= number_with_precision(accumulation_plan[:allocation_amount], precision: 0) %></strong>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td class="text-right">
                  <% if accumulation_plan %>
                    <strong><%= accumulation_plan[:time_horizon] %> months</strong>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <% if has_ai_data %>
                  <td class="text-right">
                    <% if candidate[:ai_confidence] %>
                      <span class="badge bg-info" title="AI Confidence">
                        <%= number_with_precision(candidate[:ai_confidence], precision: 0) %>
                      </span>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                <% end %>
                <td style="max-width: 250px;">
                  <% rec = candidate[:recommendation] || "N/A" %>
                  <% rec_class = case rec
                       when /ACCUMULATE|BUY/i then "success"
                       when /WAIT/i then "warning"
                       when /NOT READY|Avoid/i then "danger"
                       when /Already in|Monitor/i then "info"
                       else "secondary"
                     end %>
                  <span class="badge bg-<%= rec_class %>" title="<%= candidate[:setup_reason] || '' %>">
                    <%= rec %>
                  </span>
                  <% if candidate[:setup_reason] && !candidate[:setup_reason].empty? %>
                    <small class="text-muted d-block mt-1" style="font-size: 0.7rem;">
                      <%= truncate(candidate[:setup_reason], length: 50) %>
                    </small>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <!-- Full mode for other tabs -->
      <%= render partial: "longterm_screener_table", locals: { candidates: candidates, show_recommendation: show_recommendation, show_position: show_position } %>
    <% end %>
  </div>
</div>

<script>
  (function() {
    const table = document.getElementById('longterm-screener-results-table');
    if (!table) return;

    // Toggle functionality removed - Recommendations tab shows all actionable columns directly

    // Sorting functionality
    const tbody = table.querySelector('tbody');
    const headers = table.querySelectorAll('th.sortable');
    let currentSort = { column: null, direction: null };

    headers.forEach(header => {
      header.addEventListener('click', function() {
        const sortColumn = this.dataset.sort;
        const sortType = this.dataset.sortType || 'string';

        let direction = 'asc';
        if (currentSort.column === sortColumn && currentSort.direction === 'asc') {
          direction = 'desc';
        }

        currentSort = { column: sortColumn, direction: direction };

        headers.forEach(h => {
          h.classList.remove('sort-asc', 'sort-desc');
        });

        this.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');

        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a, b) => {
          const dataKey = sortColumn.replace(/-/g, '');
          let aVal = a.dataset[dataKey] || '';
          let bVal = b.dataset[dataKey] || '';

          if (sortType === 'number') {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
            return direction === 'asc' ? aVal - bVal : bVal - aVal;
          } else {
            aVal = (aVal || '').toString().toLowerCase();
            bVal = (bVal || '').toString().toLowerCase();
            return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
          }
        });

        rows.forEach(row => tbody.appendChild(row));
      });
    });
  })();
</script>
