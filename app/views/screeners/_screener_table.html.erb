<% show_recommendation = local_assigns.fetch(:show_recommendation, false) %>
<% show_position = local_assigns.fetch(:show_position, false) %>

<div class="card">
  <div class="card-body p-2">
    <div class="mb-2 d-flex justify-content-end">
      <button type="button" class="btn btn-sm btn-outline-secondary" id="toggle-tech-details-full" style="font-size: 0.75rem;">
        <i class="bi bi-chevron-down" id="tech-icon-full"></i> Show Technical Details
      </button>
    </div>
    <div class="table-responsive">
      <table class="table table-sm table-hover mb-0 screener-table" id="screener-results-table">
        <thead>
          <tr>
            <th class="sortable text-right" data-sort="rank" data-sort-type="number">Rank</th>
            <th class="sortable" data-sort="symbol" data-sort-type="string">Symbol</th>
            <th class="sortable text-right" data-sort="score" data-sort-type="number">Score</th>
            <th class="sortable text-right tech-col" data-sort="base_score" data-sort-type="number" style="display: none;">Base</th>
            <th class="sortable text-right tech-col" data-sort="mtf_score" data-sort-type="number" style="display: none;">MTF</th>
            <th class="sortable" data-sort="setup_status" data-sort-type="string">Setup</th>
            <th class="sortable text-right" data-sort="price" data-sort-type="number">Price</th>
            <% has_trade_plan = candidates.any? { |c| c[:trade_plan] } %>
            <% if has_trade_plan %>
              <th class="sortable text-right" data-sort="entry" data-sort-type="number">Entry</th>
              <th class="sortable text-right" data-sort="sl" data-sort-type="number">SL</th>
              <th class="sortable text-right" data-sort="tp" data-sort-type="number">TP</th>
              <th class="sortable text-right" data-sort="rr" data-sort-type="number">RR</th>
              <th class="sortable text-right" data-sort="qty" data-sort-type="number">Qty</th>
              <th class="sortable text-right" data-sort="risk" data-sort-type="number">Risk ₹</th>
            <% end %>
            <th class="sortable text-right tech-col" data-sort="rsi" data-sort-type="number" style="display: none;">RSI</th>
            <th class="sortable text-right tech-col" data-sort="adx" data-sort-type="number" style="display: none;">ADX</th>
            <th class="sortable" data-sort="trend" data-sort-type="string">Trend</th>
            <% has_ai_data = candidates.any? { |c| c[:ai_score] || c[:ai_confidence] } %>
            <% if has_ai_data %>
              <th class="sortable text-right" data-sort="ai_score" data-sort-type="number">AI Score</th>
              <th class="sortable text-right" data-sort="ai_confidence" data-sort-type="number">AI Confidence</th>
            <% end %>
            <% if show_recommendation %>
              <th class="sortable" data-sort="recommendation" data-sort-type="string">Recommendation</th>
            <% end %>
            <% if show_position %>
              <th>Position</th>
            <% end %>
          </tr>
        </thead>
        <tbody data-screener-results="true" data-screener-type="swing">
          <% candidates.each_with_index do |candidate, index| %>
            <% indicators = candidate[:indicators] || {} %>
            <% latest_close = indicators[:latest_close] || indicators["latest_close"] || candidate.dig(:daily_indicators, :latest_close) || 0 %>
            <% rsi = indicators[:rsi] || indicators["rsi"] || candidate.dig(:daily_indicators, :rsi) %>
            <% adx = indicators[:adx] || indicators["adx"] || candidate.dig(:daily_indicators, :adx) %>
            <% st = indicators[:supertrend] || indicators["supertrend"] || candidate.dig(:weekly_indicators, :supertrend) %>
            <% st_direction = st ? (st[:direction] || st["direction"]) : nil %>
            <% st_direction = st_direction.to_sym if st_direction.is_a?(String) %>
            <% ema20 = indicators[:ema20] || indicators["ema20"] || candidate.dig(:daily_indicators, :ema20) %>
            <% ema50 = indicators[:ema50] || indicators["ema50"] || candidate.dig(:daily_indicators, :ema50) %>
            <% ema_trend = (ema20 && ema50) ? (ema20 > ema50 ? "BULL" : "BEAR") : "" %>
            <% macd = indicators[:macd] || indicators["macd"] || candidate.dig(:daily_indicators, :macd) %>
            <% macd_trend = (macd.is_a?(Array) && macd.size >= 2) ? (macd[0] > macd[1] ? "BULL" : "BEAR") : "" %>
            <%
              instrument_key = nil
              if candidate[:instrument_id]
                instrument = Instrument.find_by(id: candidate[:instrument_id])
                instrument_key = instrument ? "#{instrument.exchange_segment}:#{instrument.security_id}" : nil
              end
            %>
            <tr data-screener-symbol="<%= candidate[:symbol] %>"
                data-screener-instrument-id="<%= candidate[:instrument_id] %>"
                <% if instrument_key %>
                  data-instrument-key="<%= instrument_key %>"
                <% end %>
                data-rank="<%= index + 1 %>"
                data-symbol="<%= candidate[:symbol] %>"
                data-score="<%= candidate[:score] || 0 %>"
                data-base-score="<%= candidate[:base_score] || 0 %>"
                data-mtf-score="<%= candidate[:mtf_score] || 0 %>"
                data-price="<%= latest_close %>"
                data-rsi="<%= rsi || 0 %>"
                data-adx="<%= adx || 0 %>"
                data-supertrend="<%= st_direction ? st_direction.to_s.upcase : '' %>"
                data-ematrend="<%= ema_trend %>"
                data-macd="<%= macd_trend %>"
                data-ai-score="<%= candidate[:ai_score] || 0 %>"
                data-ai-confidence="<%= candidate[:ai_confidence] || 0 %>"
                data-recommendation="<%= candidate[:recommendation] || '' %>"
                data-setup-status="<%= candidate[:setup_status] || '' %>"
                <% if candidate[:trade_plan] %>
                  data-entry="<%= candidate[:trade_plan][:entry_price] || 0 %>"
                  data-sl="<%= candidate[:trade_plan][:stop_loss] || 0 %>"
                  data-tp="<%= candidate[:trade_plan][:take_profit] || 0 %>"
                  data-rr="<%= candidate[:trade_plan][:risk_reward] || 0 %>"
                  data-qty="<%= candidate[:trade_plan][:quantity] || 0 %>"
                  data-risk="<%= candidate[:trade_plan][:risk_amount] || 0 %>"
                <% end %>>
              <td class="text-right"><strong>#<%= index + 1 %></strong></td>
              <td><strong><%= candidate[:symbol] %></strong></td>
              <td class="text-right">
                <span class="badge bg-<%= candidate[:score] >= 70 ? 'success' : candidate[:score] >= 50 ? 'warning' : 'secondary' %>">
                  <%= number_with_precision(candidate[:score], precision: 1) %>
                </span>
              </td>
              <td class="text-right tech-col" style="display: none;"><%= number_with_precision(candidate[:base_score] || 0, precision: 1) %></td>
              <td class="text-right tech-col" style="display: none;"><%= number_with_precision(candidate[:mtf_score] || 0, precision: 1) %></td>
              <td>
                <% setup_status = candidate[:setup_status] || "UNKNOWN" %>
                <% setup_class = case setup_status
                     when "READY" then "success"
                     when "WAIT_PULLBACK", "WAIT_BREAKOUT" then "warning"
                     when "IN_POSITION" then "info"
                     else "secondary"
                   end %>
                <span class="badge bg-<%= setup_class %>" title="<%= candidate[:setup_reason] || '' %>">
                  <%= setup_status.gsub('_', ' ') %>
                </span>
              </td>
              <td class="text-right js-ltp-cell" data-price-cell="true" data-instrument-key="<%= instrument_key %>">₹<%= number_with_precision(latest_close, precision: 2) %></td>
              <% if has_trade_plan %>
                <% trade_plan = candidate[:trade_plan] %>
                <% if trade_plan %>
                  <td class="text-right">
                    <strong>₹<%= number_with_precision(trade_plan[:entry_price], precision: 2) %></strong>
                    <small class="text-muted d-block" style="font-size: 0.7rem;">
                      <%= trade_plan[:entry_zone] %>
                    </small>
                  </td>
                  <td class="text-right">
                    <span class="badge bg-danger">₹<%= number_with_precision(trade_plan[:stop_loss], precision: 2) %></span>
                  </td>
                  <td class="text-right">
                    <span class="badge bg-success">₹<%= number_with_precision(trade_plan[:take_profit], precision: 2) %></span>
                  </td>
                  <td class="text-right">
                    <span class="badge bg-<%= trade_plan[:risk_reward] >= 2.5 ? 'success' : 'warning' %>">
                      <%= number_with_precision(trade_plan[:risk_reward], precision: 1) %>R
                    </span>
                  </td>
                  <td class="text-right">
                    <strong><%= trade_plan[:quantity] %></strong>
                    <% if trade_plan[:max_capital_pct] && trade_plan[:max_capital_pct] > 0 %>
                      <small class="text-muted d-block" style="font-size: 0.7rem;">
                        <%= number_with_precision(trade_plan[:max_capital_pct], precision: 1) %>% capital
                      </small>
                    <% end %>
                  </td>
                  <td class="text-right">
                    <strong class="text-danger">₹<%= number_with_precision(trade_plan[:risk_amount], precision: 0) %></strong>
                    <small class="text-muted d-block" style="font-size: 0.7rem;">
                      Capital: ₹<%= number_with_precision(trade_plan[:capital_used], precision: 0) %>
                    </small>
                  </td>
                <% else %>
                  <td colspan="6" class="text-muted text-center">-</td>
                <% end %>
              <% end %>
              <td class="text-right tech-col" style="display: none;">
                <% if rsi %>
                  <span class="badge bg-<%= rsi > 70 ? 'danger' : rsi < 30 ? 'success' : 'info' %>">
                    <%= number_with_precision(rsi, precision: 1) %>
                  </span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td class="text-right tech-col" style="display: none;">
                <% if adx %>
                  <span class="badge bg-<%= adx > 25 ? 'success' : 'secondary' %>">
                    <%= number_with_precision(adx, precision: 1) %>
                  </span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td>
                <% trend_indicators = [] %>
                <% if st && st_direction %>
                  <% trend_indicators << st_direction.to_s.upcase %>
                <% end %>
                <% if ema_trend.present? %>
                  <% trend_indicators << ema_trend %>
                <% end %>
                <% if macd_trend.present? && macd_trend == 'BULL' %>
                  <% trend_indicators << 'MACD' %>
                <% end %>
                <% if trend_indicators.any? %>
                  <span class="badge bg-success" title="<%= trend_indicators.join(', ') %>">
                    <%= trend_indicators.uniq.join(' / ') %>
                  </span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <% if candidate[:ai_score] || candidate[:ai_confidence] %>
                <td class="text-right">
                  <% if candidate[:ai_score] %>
                    <span class="badge bg-<%= candidate[:ai_score] >= 80 ? 'success' : candidate[:ai_score] >= 60 ? 'warning' : 'secondary' %>">
                      <%= number_with_precision(candidate[:ai_score], precision: 1) %>
                    </span>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td class="text-right">
                  <% if candidate[:ai_confidence] %>
                    <span class="badge bg-info">
                      <%= number_with_precision(candidate[:ai_confidence], precision: 1) %>
                    </span>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
              <% end %>
              <% if show_recommendation %>
                <td style="max-width: 300px;">
                  <% rec = candidate[:recommendation] || "N/A" %>
                  <% rec_class = case rec
                       when /BUY/i then "success"
                       when /WAIT/i then "warning"
                       when /NOT READY|Avoid/i then "danger"
                       when /Already in|Monitor/i then "info"
                       else "secondary"
                     end %>
                  <% if candidate[:trade_plan] %>
                    <% tp = candidate[:trade_plan] %>
                    <div class="small">
                      <span class="badge bg-<%= rec_class %> mb-1 d-block">
                        <%= rec %>
                      </span>
                      <div class="text-muted" style="font-size: 0.7rem; line-height: 1.3;">
                        Entry: ₹<%= number_with_precision(tp[:entry_price], precision: 2) %><br>
                        SL: ₹<%= number_with_precision(tp[:stop_loss], precision: 2) %> |
                        TP: ₹<%= number_with_precision(tp[:take_profit], precision: 2) %><br>
                        Qty: <%= tp[:quantity] %> | Risk: ₹<%= number_with_precision(tp[:risk_amount], precision: 0) %>
                      </div>
                    </div>
                  <% else %>
                    <span class="badge bg-<%= rec_class %>">
                      <%= rec %>
                    </span>
                    <% if candidate[:setup_reason] %>
                      <small class="text-muted d-block mt-1" style="font-size: 0.7rem;">
                        <%= candidate[:setup_reason] %>
                      </small>
                    <% end %>
                  <% end %>
                </td>
              <% end %>
              <% if show_position && candidate[:position] %>
                <td>
                  <% pos = candidate[:position] %>
                  <% mode = candidate[:position_mode] || "unknown" %>
                  <span class="badge bg-<%= mode == 'live' ? 'danger' : 'info' %>">
                    <%= mode.upcase %>
                  </span>
                  <small class="text-muted d-block" style="font-size: 0.75rem; line-height: 1.2;">
                    Entry: ₹<%= number_with_precision(pos.entry_price, precision: 2) %>
                    <% if pos.respond_to?(:unrealized_pnl) %>
                      | P&L: <span class="<%= pos.unrealized_pnl >= 0 ? 'text-success' : 'text-danger' %>">
                        ₹<%= number_with_precision(pos.unrealized_pnl, precision: 0) %>
                      </span>
                    <% end %>
                  </small>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  (function() {
    const table = document.getElementById('screener-results-table');
    if (!table) return;

    // Toggle technical details
    const toggleBtn = document.getElementById('toggle-tech-details-full');
    if (toggleBtn) {
      let detailsVisible = false;
      toggleBtn.addEventListener('click', function() {
        detailsVisible = !detailsVisible;
        const cols = table.querySelectorAll('.tech-col');
        const icon = document.getElementById('tech-icon-full');

        cols.forEach(col => {
          col.style.display = detailsVisible ? '' : 'none';
        });

        if (icon) {
          icon.className = detailsVisible ? 'bi bi-chevron-up' : 'bi bi-chevron-down';
        }

        toggleBtn.innerHTML = (detailsVisible ? '<i class="bi bi-chevron-up" id="tech-icon-full"></i> Hide' : '<i class="bi bi-chevron-down" id="tech-icon-full"></i> Show') + ' Technical Details';
      });
    }

    const tbody = table.querySelector('tbody');
    const headers = table.querySelectorAll('th.sortable');
    let currentSort = { column: null, direction: null };

    headers.forEach(header => {
      header.addEventListener('click', function() {
        const sortColumn = this.dataset.sort;
        const sortType = this.dataset.sortType || 'string';

        // Determine sort direction
        let direction = 'asc';
        if (currentSort.column === sortColumn && currentSort.direction === 'asc') {
          direction = 'desc';
        }

        // Update current sort
        currentSort = { column: sortColumn, direction: direction };

        // Remove all sort classes
        headers.forEach(h => {
          h.classList.remove('sort-asc', 'sort-desc');
        });

        // Add sort class to current header
        this.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');

        // Sort rows
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a, b) => {
          // Convert kebab-case to camelCase for dataset access (e.g., ema-trend -> ematrend)
          const dataKey = sortColumn.replace(/-/g, '');
          let aVal = a.dataset[dataKey] || '';
          let bVal = b.dataset[dataKey] || '';

          if (sortType === 'number') {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
            return direction === 'asc' ? aVal - bVal : bVal - aVal;
          } else {
            aVal = (aVal || '').toString().toLowerCase();
            bVal = (bVal || '').toString().toLowerCase();
            if (direction === 'asc') {
              return aVal.localeCompare(bVal);
            } else {
              return bVal.localeCompare(aVal);
            }
          }
        });

        // Re-append sorted rows
        rows.forEach(row => tbody.appendChild(row));
      });
    });
  })();
</script>
