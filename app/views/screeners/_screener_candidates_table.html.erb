<%# SCREENER CONTRACT: This partial shows ONLY candidate generation data - informational, not actionable %>
<%# Used for "Screener" / "All Results" / "Bullish Stocks" tabs - shows market state only %>

<div class="card">
  <div class="card-body p-2">
    <div class="mb-2 d-flex justify-content-between align-items-center">
      <small class="text-muted">
        <i class="bi bi-info-circle"></i> Market Scan – Candidates Only (Informational)
      </small>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="toggle-tech-details-candidates" style="cursor: pointer;" checked>
        <label class="form-check-label" for="toggle-tech-details-candidates" style="cursor: pointer; font-size: 0.75rem;">
          Show Technical Details
        </label>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-sm table-hover mb-0 screener-table" id="screener-candidates-table">
        <thead>
          <tr>
            <th class="sortable text-right" data-sort="rank" data-sort-type="number">Rank</th>
            <th class="sortable" data-sort="symbol" data-sort-type="string">Symbol</th>
            <th class="sortable text-right" data-sort="score" data-sort-type="number">Score</th>
            <th class="sortable text-right tech-col" data-sort="base_score" data-sort-type="number" style="display: none;">Base</th>
            <th class="sortable text-right tech-col" data-sort="mtf_score" data-sort-type="number" style="display: none;">MTF</th>
            <th class="sortable text-right" data-sort="price" data-sort-type="number">Price</th>
            <th class="sortable text-right tech-col" data-sort="rsi" data-sort-type="number" style="display: none;">RSI</th>
            <th class="sortable text-right tech-col" data-sort="adx" data-sort-type="number" style="display: none;">ADX</th>
            <th class="sortable text-right tech-col" data-sort="atr" data-sort-type="number" style="display: none;">ATR%</th>
            <th class="sortable" data-sort="trend" data-sort-type="string">Trend</th>
            <th class="sortable text-right tech-col" data-sort="distance_ema20" data-sort-type="number" style="display: none;">Dist EMA20</th>
            <th class="sortable text-right tech-col" data-sort="distance_ema50" data-sort-type="number" style="display: none;">Dist EMA50</th>
          </tr>
        </thead>
        <tbody data-screener-results="true" data-screener-type="swing">
          <% candidates.each_with_index do |candidate, index| %>
            <% indicators = candidate[:indicators] || {} %>
            <% latest_close = indicators[:latest_close] || indicators["latest_close"] || candidate.dig(:daily_indicators, :latest_close) || 0 %>
            <% rsi = indicators[:rsi] || indicators["rsi"] || candidate.dig(:daily_indicators, :rsi) %>
            <% adx = indicators[:adx] || indicators["adx"] || candidate.dig(:daily_indicators, :adx) %>
            <% atr = indicators[:atr] || indicators["atr"] || candidate.dig(:daily_indicators, :atr) %>
            <% atr_percent = atr && latest_close > 0 ? (atr / latest_close * 100).round(2) : nil %>
            <% st = indicators[:supertrend] || indicators["supertrend"] || candidate.dig(:weekly_indicators, :supertrend) %>
            <% st_direction = st ? (st[:direction] || st["direction"]) : nil %>
            <% st_direction = st_direction.to_sym if st_direction.is_a?(String) %>
            <% ema20 = indicators[:ema20] || indicators["ema20"] || candidate.dig(:daily_indicators, :ema20) %>
            <% ema50 = indicators[:ema50] || indicators["ema50"] || candidate.dig(:daily_indicators, :ema50) %>
            <% ema_trend = (ema20 && ema50) ? (ema20 > ema50 ? "BULL" : "BEAR") : "" %>
            <% distance_ema20 = ema20 && latest_close > 0 ? ((latest_close - ema20) / ema20 * 100).round(2) : nil %>
            <% distance_ema50 = ema50 && latest_close > 0 ? ((latest_close - ema50) / ema50 * 100).round(2) : nil %>
            <% macd = indicators[:macd] || indicators["macd"] || candidate.dig(:daily_indicators, :macd) %>
            <% macd_trend = (macd.is_a?(Array) && macd.size >= 2) ? (macd[0] > macd[1] ? "BULL" : "BEAR") : "" %>
            <%
              instrument_key = nil
              if candidate[:instrument_id]
                instrument = Instrument.find_by(id: candidate[:instrument_id])
                if instrument && instrument.exchange_segment.present? && instrument.security_id.present?
                  instrument_key = "#{instrument.exchange_segment}:#{instrument.security_id}"
                else
                  Rails.logger.warn("[Screener] Missing exchange_segment or security_id for instrument_id=#{candidate[:instrument_id]}, symbol=#{candidate[:symbol]}")
                end
              end
            %>
            <tr data-screener-symbol="<%= candidate[:symbol] %>"
                data-screener-instrument-id="<%= candidate[:instrument_id] %>"
                <% if instrument_key %>
                  data-instrument-key="<%= instrument_key %>"
                <% end %>
                data-rank="<%= index + 1 %>"
                data-symbol="<%= candidate[:symbol] %>"
                data-score="<%= candidate[:score] || 0 %>"
                data-base-score="<%= candidate[:base_score] || 0 %>"
                data-mtf-score="<%= candidate[:mtf_score] || 0 %>"
                data-price="<%= latest_close %>"
                data-rsi="<%= rsi || 0 %>"
                data-adx="<%= adx || 0 %>"
                data-atr="<%= atr_percent || 0 %>"
                data-distance-ema20="<%= distance_ema20 || 0 %>"
                data-distance-ema50="<%= distance_ema50 || 0 %>"
                data-supertrend="<%= st_direction ? st_direction.to_s.upcase : '' %>"
                data-ematrend="<%= ema_trend %>"
                data-macd="<%= macd_trend %>">
              <td class="text-right"><strong>#<%= index + 1 %></strong></td>
              <td><strong><%= candidate[:symbol] %></strong></td>
              <td class="text-right">
                <span class="badge bg-<%= candidate[:score] >= 70 ? 'success' : candidate[:score] >= 50 ? 'warning' : 'secondary' %>">
                  <%= number_with_precision(candidate[:score], precision: 1) %>
                </span>
              </td>
              <td class="text-right tech-col" style="display: none;">
                <%= number_with_precision(candidate[:base_score] || 0, precision: 1) %>
              </td>
              <td class="text-right tech-col" style="display: none;">
                <%= number_with_precision(candidate[:mtf_score] || 0, precision: 1) %>
              </td>
              <td class="text-right js-ltp-cell" data-price-cell="true" <% if instrument_key %>data-instrument-key="<%= instrument_key %>"<% end %>>
                ₹<%= number_with_precision(latest_close, precision: 2) %>
              </td>
              <td class="text-right tech-col" style="display: none;">
                <% if rsi %>
                  <span class="badge bg-<%= rsi > 70 ? 'danger' : rsi < 30 ? 'success' : 'info' %>">
                    <%= number_with_precision(rsi, precision: 1) %>
                  </span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td class="text-right tech-col" style="display: none;">
                <% if adx %>
                  <span class="badge bg-<%= adx > 25 ? 'success' : 'secondary' %>">
                    <%= number_with_precision(adx, precision: 1) %>
                  </span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td class="text-right tech-col" style="display: none;">
                <% if atr_percent %>
                  <span class="badge bg-<%= atr_percent.between?(2, 5) ? 'success' : atr_percent.between?(1.5, 6) ? 'info' : 'secondary' %>">
                    <%= number_with_precision(atr_percent, precision: 1) %>%
                  </span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td>
                <% trend_indicators = [] %>
                <% if st && st_direction %>
                  <% trend_indicators << st_direction.to_s.upcase %>
                <% end %>
                <% if ema_trend.present? %>
                  <% trend_indicators << ema_trend %>
                <% end %>
                <% if macd_trend.present? && macd_trend == 'BULL' %>
                  <% trend_indicators << 'MACD' %>
                <% end %>
                <% if trend_indicators.any? %>
                  <span class="badge bg-success" title="<%= trend_indicators.join(', ') %>">
                    <%= trend_indicators.uniq.join(' / ') %>
                  </span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td class="text-right tech-col" style="display: none;">
                <% if distance_ema20 %>
                  <span class="<%= distance_ema20.abs <= 2 ? 'text-success' : distance_ema20.abs <= 5 ? 'text-info' : 'text-muted' %>">
                    <%= distance_ema20 > 0 ? '+' : '' %><%= number_with_precision(distance_ema20, precision: 1) %>%
                  </span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td class="text-right tech-col" style="display: none;">
                <% if distance_ema50 %>
                  <span class="<%= distance_ema50.abs <= 5 ? 'text-success' : distance_ema50.abs <= 10 ? 'text-info' : 'text-muted' %>">
                    <%= distance_ema50 > 0 ? '+' : '' %><%= number_with_precision(distance_ema50, precision: 1) %>%
                  </span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  (function() {
    const table = document.getElementById('screener-candidates-table');
    if (!table) return;

    // Toggle technical details
    const toggleCheckbox = document.getElementById('toggle-tech-details-candidates');
    if (toggleCheckbox) {
      // Show columns by default if checkbox is checked
      const showByDefault = toggleCheckbox.checked;
      const cols = table.querySelectorAll('.tech-col');
      cols.forEach(col => {
        col.style.display = showByDefault ? '' : 'none';
      });

      toggleCheckbox.addEventListener('change', function() {
        const detailsVisible = this.checked;
        const cols = table.querySelectorAll('.tech-col');

        cols.forEach(col => {
          col.style.display = detailsVisible ? '' : 'none';
        });
      });
    }

    // Sorting functionality
    const tbody = table.querySelector('tbody');
    const headers = table.querySelectorAll('th.sortable');
    let currentSort = { column: null, direction: null };

    headers.forEach(header => {
      header.addEventListener('click', function() {
        const sortColumn = this.dataset.sort;
        const sortType = this.dataset.sortType || 'string';

        let direction = 'asc';
        if (currentSort.column === sortColumn && currentSort.direction === 'asc') {
          direction = 'desc';
        }

        currentSort = { column: sortColumn, direction: direction };

        headers.forEach(h => {
          h.classList.remove('sort-asc', 'sort-desc');
        });

        this.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');

        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a, b) => {
          const dataKey = sortColumn.replace(/-/g, '');
          let aVal = a.dataset[dataKey] || '';
          let bVal = b.dataset[dataKey] || '';

          if (sortType === 'number') {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
            return direction === 'asc' ? aVal - bVal : bVal - aVal;
          } else {
            aVal = (aVal || '').toString().toLowerCase();
            bVal = (bVal || '').toString().toLowerCase();
            return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
          }
        });

        rows.forEach(row => tbody.appendChild(row));
      });
    });
  })();
</script>
