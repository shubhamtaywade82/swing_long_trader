<% content_for :page_title, "System Monitoring" %>

<div class="monitoring-page">
  <p class="text-muted mb-3 small">Monitor system health and job status</p>

  <!-- System Health -->
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="card">
        <div class="card-body text-center p-2">
          <i class="bi bi-database" style="font-size: 2rem; color: <%= @system_health[:database] == 'Healthy' ? '#28a745' : '#dc3545' %>;"></i>
          <h5 class="mt-2">Database</h5>
          <p class="mb-0">
            <span class="badge bg-<%= @system_health[:database] == 'Healthy' ? 'success' : 'danger' %>">
              <%= @system_health[:database] %>
            </span>
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card">
        <div class="card-body text-center p-2">
          <i class="bi bi-cloud" style="font-size: 2rem; color: #6c757d;"></i>
          <h5 class="mt-2">DhanHQ API</h5>
          <p class="mb-0">
            <span class="badge bg-secondary">
              <%= @system_health[:dhan_api] %>
            </span>
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card">
        <div class="card-body text-center p-2">
          <i class="bi bi-telegram" style="font-size: 2rem; color: #6c757d;"></i>
          <h5 class="mt-2">Telegram Bot</h5>
          <p class="mb-0">
            <span class="badge bg-secondary">
              <%= @system_health[:telegram] %>
            </span>
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card">
        <div class="card-body text-center p-2">
          <i class="bi bi-list-task" style="font-size: 2rem; color: <%= @system_health[:queue] == 'Healthy' ? '#28a745' : '#dc3545' %>;"></i>
          <h5 class="mt-2">Job Queue</h5>
          <p class="mb-0">
            <span class="badge bg-<%= @system_health[:queue] == 'Healthy' ? 'success' : 'danger' %>">
              <%= @system_health[:queue] %>
            </span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Queue Statistics -->
  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="card">
        <div class="card-body text-center p-2">
          <h3 class="text-warning"><%= @queue_stats[:pending] %></h3>
          <p class="mb-0">Pending Jobs</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-body text-center p-2">
          <h3 class="text-info"><%= @queue_stats[:running] %></h3>
          <p class="mb-0">Running Jobs</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-body text-center p-2">
          <h3 class="text-danger"><%= @queue_stats[:failed] %></h3>
          <p class="mb-0">Failed Jobs</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Job Status -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Job Status</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
          <thead>
            <tr>
              <th>Job</th>
              <th>Last Run</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Swing Screener</strong></td>
              <td><%= @jobs_status[:last_screener_run] %></td>
              <td><span class="badge bg-info">Scheduled</span></td>
            </tr>
            <tr>
              <td><strong>Signal Analysis</strong></td>
              <td><%= @jobs_status[:last_analysis_run] %></td>
              <td><span class="badge bg-info">Scheduled</span></td>
            </tr>
            <tr>
              <td><strong>Entry Monitor</strong></td>
              <td><%= @jobs_status[:last_entry_monitor] %></td>
              <td><span class="badge bg-info">Scheduled</span></td>
            </tr>
            <tr>
              <td><strong>Exit Monitor</strong></td>
              <td><%= @jobs_status[:last_exit_monitor] %></td>
              <td><span class="badge bg-info">Scheduled</span></td>
            </tr>
            <tr>
              <td><strong>Candle Ingestion</strong></td>
              <td><%= @jobs_status[:last_candle_ingestion] %></td>
              <td><span class="badge bg-info">Scheduled</span></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
