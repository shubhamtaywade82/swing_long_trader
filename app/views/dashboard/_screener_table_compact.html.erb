<% show_recommendation = local_assigns.fetch(:show_recommendation, false) %>
<% show_position = local_assigns.fetch(:show_position, false) %>
<% compact_mode = local_assigns.fetch(:compact_mode, true) %>

<div class="card">
  <div class="card-body p-2">
    <% if compact_mode && show_recommendation %>
      <!-- Compact mode for Recommendations tab - focused on actionable trade info -->
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0 screener-table" id="screener-results-table">
          <thead>
            <tr>
              <th class="sortable text-right" data-sort="rank" data-sort-type="number">#</th>
              <th class="sortable" data-sort="symbol" data-sort-type="string">Symbol</th>
              <th class="sortable text-right" data-sort="score" data-sort-type="number">Score</th>
              <th class="sortable" data-sort="setup_status" data-sort-type="string">Status</th>
              <th class="sortable text-right" data-sort="price" data-sort-type="number">LTP</th>
              <th class="sortable text-right" data-sort="entry" data-sort-type="number">Trade Plan</th>
              <th class="sortable text-right" data-sort="qty" data-sort-type="number">Qty</th>
              <th class="sortable text-right" data-sort="risk" data-sort-type="number">Risk</th>
              <th class="sortable text-right" data-sort="rr" data-sort-type="number">RR</th>
              <% has_ai_data = candidates.any? { |c| c[:ai_score] || c[:ai_confidence] } %>
              <% if has_ai_data %>
                <th class="sortable text-right" data-sort="ai_confidence" data-sort-type="number">AI</th>
              <% end %>
              <th>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="toggle-tech-details" style="font-size: 0.7rem;">
                  <i class="bi bi-chevron-down" id="tech-icon"></i> Details
                </button>
              </th>
            </tr>
          </thead>
          <tbody data-screener-results="true" data-screener-type="swing">
            <% candidates.each_with_index do |candidate, index| %>
              <% indicators = candidate[:indicators] || {} %>
              <% latest_close = indicators[:latest_close] || indicators["latest_close"] || candidate.dig(:daily_indicators, :latest_close) || 0 %>
              <% rsi = indicators[:rsi] || indicators["rsi"] || candidate.dig(:daily_indicators, :rsi) %>
              <% adx = indicators[:adx] || indicators["adx"] || candidate.dig(:daily_indicators, :adx) %>
              <% trade_plan = candidate[:trade_plan] %>
              <% setup_status = candidate[:setup_status] || "UNKNOWN" %>
              <tr data-screener-symbol="<%= candidate[:symbol] %>"
                  data-screener-instrument-id="<%= candidate[:instrument_id] %>"
                  data-rank="<%= index + 1 %>"
                  data-symbol="<%= candidate[:symbol] %>"
                  data-score="<%= candidate[:score] || 0 %>"
                  data-setup-status="<%= setup_status %>"
                  data-price="<%= latest_close %>"
                  <% if trade_plan %>
                    data-entry="<%= trade_plan[:entry_price] || 0 %>"
                    data-sl="<%= trade_plan[:stop_loss] || 0 %>"
                    data-tp="<%= trade_plan[:take_profit] || 0 %>"
                    data-rr="<%= trade_plan[:risk_reward] || 0 %>"
                    data-qty="<%= trade_plan[:quantity] || 0 %>"
                    data-risk="<%= trade_plan[:risk_amount] || 0 %>"
                  <% end %>
                  data-ai-confidence="<%= candidate[:ai_confidence] || 0 %>">
                <td class="text-right"><strong>#<%= index + 1 %></strong></td>
                <td><strong><%= candidate[:symbol] %></strong></td>
                <td class="text-right">
                  <span class="badge bg-<%= candidate[:score] >= 70 ? 'success' : candidate[:score] >= 50 ? 'warning' : 'secondary' %>">
                    <%= number_with_precision(candidate[:score], precision: 1) %>
                  </span>
                </td>
                <td>
                  <% setup_class = case setup_status
                       when "READY" then "success"
                       when "WAIT_PULLBACK", "WAIT_BREAKOUT" then "warning"
                       when "IN_POSITION" then "info"
                       else "secondary"
                     end %>
                  <span class="badge bg-<%= setup_class %>" title="<%= candidate[:setup_reason] || '' %>">
                    <%= setup_status.gsub('_', ' ') %>
                  </span>
                </td>
                <td class="text-right">
                  <strong class="<%= latest_close > 0 ? 'text-primary' : 'text-muted' %>">
                    ₹<%= number_with_precision(latest_close, precision: 2) %>
                  </strong>
                </td>
                <td class="text-right">
                  <% if trade_plan %>
                    <div style="line-height: 1.4;">
                      <div><strong>Entry:</strong> ₹<%= number_with_precision(trade_plan[:entry_price], precision: 2) %></div>
                      <div class="text-danger" style="font-size: 0.85rem;"><strong>SL:</strong> ₹<%= number_with_precision(trade_plan[:stop_loss], precision: 2) %></div>
                      <div class="text-success" style="font-size: 0.85rem;"><strong>TP:</strong> ₹<%= number_with_precision(trade_plan[:take_profit], precision: 2) %></div>
                    </div>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td class="text-right">
                  <% if trade_plan %>
                    <strong><%= trade_plan[:quantity] %></strong>
                    <% if trade_plan[:max_capital_pct] && trade_plan[:max_capital_pct] > 0 %>
                      <small class="text-muted d-block" style="font-size: 0.7rem;">
                        <%= number_with_precision(trade_plan[:max_capital_pct], precision: 1) %>% cap
                      </small>
                    <% end %>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td class="text-right">
                  <% if trade_plan %>
                    <strong class="text-danger">₹<%= number_with_precision(trade_plan[:risk_amount], precision: 0) %></strong>
                    <small class="text-muted d-block" style="font-size: 0.7rem;">
                      Cap: ₹<%= number_with_precision(trade_plan[:capital_used], precision: 0) %>
                    </small>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td class="text-right">
                  <% if trade_plan %>
                    <span class="badge bg-<%= trade_plan[:risk_reward] >= 2.5 ? 'success' : 'warning' %>">
                      <%= number_with_precision(trade_plan[:risk_reward], precision: 1) %>R
                    </span>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <% if has_ai_data %>
                  <td class="text-right">
                    <% if candidate[:ai_confidence] %>
                      <span class="badge bg-info" title="AI Confidence">
                        <%= number_with_precision(candidate[:ai_confidence], precision: 0) %>
                      </span>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                <% end %>
                <td class="tech-details-cell" style="display: none;">
                  <div style="font-size: 0.75rem; line-height: 1.5;">
                    <div><strong>Price:</strong> ₹<%= number_with_precision(latest_close, precision: 2) %></div>
                    <% if rsi %>
                      <div><strong>RSI:</strong> <span class="badge bg-<%= rsi > 70 ? 'danger' : rsi < 30 ? 'success' : 'info' %>" style="font-size: 0.7rem;"><%= number_with_precision(rsi, precision: 1) %></span></div>
                    <% end %>
                    <% if adx %>
                      <div><strong>ADX:</strong> <span class="badge bg-<%= adx > 25 ? 'success' : 'secondary' %>" style="font-size: 0.7rem;"><%= number_with_precision(adx, precision: 1) %></span></div>
                    <% end %>
                    <div><strong>Base:</strong> <%= number_with_precision(candidate[:base_score] || 0, precision: 1) %> | <strong>MTF:</strong> <%= number_with_precision(candidate[:mtf_score] || 0, precision: 1) %></div>
                    <% if candidate[:setup_reason] %>
                      <div class="text-muted" style="font-size: 0.7rem;"><%= candidate[:setup_reason] %></div>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <!-- Full mode for other tabs - use standard table -->
      <%= render partial: "screener_table", locals: { candidates: candidates, show_recommendation: show_recommendation, show_position: show_position } %>
    <% end %>
  </div>
</div>

<script>
  (function() {
    const table = document.getElementById('screener-results-table');
    if (!table) return;

    // Toggle technical details
    const toggleBtn = document.getElementById('toggle-tech-details');
    if (toggleBtn) {
      let detailsVisible = false;
      toggleBtn.addEventListener('click', function() {
        detailsVisible = !detailsVisible;
        const cells = table.querySelectorAll('.tech-details-cell');
        const icon = document.getElementById('tech-icon');

        cells.forEach(cell => {
          cell.style.display = detailsVisible ? 'table-cell' : 'none';
        });

        if (icon) {
          icon.className = detailsVisible ? 'bi bi-chevron-up' : 'bi bi-chevron-down';
        }
      });
    }

    // Sorting functionality
    const tbody = table.querySelector('tbody');
    const headers = table.querySelectorAll('th.sortable');
    let currentSort = { column: null, direction: null };

    headers.forEach(header => {
      header.addEventListener('click', function() {
        const sortColumn = this.dataset.sort;
        const sortType = this.dataset.sortType || 'string';

        let direction = 'asc';
        if (currentSort.column === sortColumn && currentSort.direction === 'asc') {
          direction = 'desc';
        }

        currentSort = { column: sortColumn, direction: direction };

        headers.forEach(h => {
          h.classList.remove('sort-asc', 'sort-desc');
        });

        this.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');

        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a, b) => {
          const dataKey = sortColumn.replace(/-/g, '');
          let aVal = a.dataset[dataKey] || '';
          let bVal = b.dataset[dataKey] || '';

          if (sortType === 'number') {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
            return direction === 'asc' ? aVal - bVal : bVal - aVal;
          } else {
            aVal = (aVal || '').toString().toLowerCase();
            bVal = (bVal || '').toString().toLowerCase();
            return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
          }
        });

        rows.forEach(row => tbody.appendChild(row));
      });
    });

    // Auto-refresh LTPs every 30 seconds
    (function() {
      const table = document.getElementById('screener-results-table');
      if (!table) return;

      const tbody = table.querySelector('tbody');
      if (!tbody) return;

      function updateLTPs() {
        // Collect all instrument IDs from the table
        const rows = tbody.querySelectorAll('tr[data-screener-instrument-id]');
        const instrumentIds = Array.from(rows).map(row =>
          row.getAttribute('data-screener-instrument-id')
        ).filter(id => id).join(',');

        if (!instrumentIds) {
          console.log('[LTP Refresh] No instrument IDs found');
          return;
        }

        console.log('[LTP Refresh] Fetching LTPs for instruments:', instrumentIds);

        // Fetch updated LTPs
        const refreshUrl = '/screeners/refresh_ltps';
        fetch(`${refreshUrl}?type=swing&instrument_ids=${instrumentIds}`, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('[LTP Refresh] Received data:', data);
          if (data.error) {
            console.error('[LTP Refresh] Error:', data.error);
            return;
          }

          if (data.ltps && Object.keys(data.ltps).length > 0) {
            let updatedCount = 0;
            // Update each row with new LTP
            rows.forEach(row => {
              const instrumentId = row.getAttribute('data-screener-instrument-id');
              // Response has string keys, so use string lookup
              const newLtp = data.ltps[instrumentId];

              if (newLtp && !isNaN(newLtp)) {
                // Find the LTP cell (5th column after #, Symbol, Score, Status)
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                  const ltpCell = cells[4]; // 0-indexed: #=0, Symbol=1, Score=2, Status=3, LTP=4

                  // Update cell content
                  const formattedPrice = new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                  }).format(newLtp).replace('₹', '₹');

                  ltpCell.innerHTML = `<strong class="text-primary">${formattedPrice}</strong>`;

                  // Update data attribute for sorting
                  row.setAttribute('data-price', newLtp);

                  // Add visual indicator that price was updated
                  ltpCell.classList.add('price-updated');
                  setTimeout(() => {
                    ltpCell.classList.remove('price-updated');
                  }, 1000);

                  updatedCount++;
                }
              }
            });
            console.log(`[LTP Refresh] Updated ${updatedCount} prices`);
          } else {
            console.warn('[LTP Refresh] No LTPs in response');
          }
        })
        .catch(error => {
          console.error('[LTP Refresh] Failed to refresh LTPs:', error);
        });
      }

      // Start auto-refresh (every 30 seconds)
      const refreshInterval = setInterval(updateLTPs, 30000);

      // Also refresh immediately after 2 seconds (to get initial update)
      setTimeout(updateLTPs, 2000);

      // Clean up on page unload
      window.addEventListener('beforeunload', () => {
        clearInterval(refreshInterval);
      });
    })();
  })();
</script>

<style>
  .price-updated {
    background-color: #d1ecf1 !important;
    transition: background-color 0.5s ease;
  }
</style>
