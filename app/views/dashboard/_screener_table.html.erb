<% show_recommendation = local_assigns.fetch(:show_recommendation, false) %>
<% show_position = local_assigns.fetch(:show_position, false) %>

<div class="card">
  <div class="card-body p-2">
    <div class="table-responsive">
      <table class="table table-sm table-hover mb-0">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Symbol</th>
            <th>Score</th>
            <th>Base Score</th>
            <th>MTF Score</th>
            <th>Price</th>
            <th>RSI</th>
            <th>ADX</th>
            <th>Supertrend</th>
            <th>EMA Trend</th>
            <th>MACD</th>
            <% has_ai_data = candidates.any? { |c| c[:ai_score] || c[:ai_confidence] } %>
            <% if has_ai_data %>
              <th>AI Score</th>
              <th>AI Confidence</th>
            <% end %>
            <% if show_recommendation %>
              <th>Recommendation</th>
            <% end %>
            <% if show_position %>
              <th>Position</th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% candidates.each_with_index do |candidate, index| %>
            <tr>
              <td><strong>#<%= index + 1 %></strong></td>
              <td><strong><%= candidate[:symbol] %></strong></td>
              <td>
                <span class="badge bg-<%= candidate[:score] >= 70 ? 'success' : candidate[:score] >= 50 ? 'warning' : 'secondary' %>">
                  <%= number_with_precision(candidate[:score], precision: 1) %>
                </span>
              </td>
              <td><%= number_with_precision(candidate[:base_score] || 0, precision: 1) %></td>
              <td><%= number_with_precision(candidate[:mtf_score] || 0, precision: 1) %></td>
              <td>₹<%= number_with_precision(candidate.dig(:indicators, :latest_close) || candidate.dig(:daily_indicators, :latest_close) || 0, precision: 2) %></td>
              <td>
                <% rsi = candidate.dig(:indicators, :rsi) || candidate.dig(:daily_indicators, :rsi) %>
                <% if rsi %>
                  <span class="badge bg-<%= rsi > 70 ? 'danger' : rsi < 30 ? 'success' : 'info' %>">
                    <%= number_with_precision(rsi, precision: 1) %>
                  </span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td>
                <% adx = candidate.dig(:indicators, :adx) || candidate.dig(:daily_indicators, :adx) %>
                <% if adx %>
                  <span class="badge bg-<%= adx > 25 ? 'success' : 'secondary' %>">
                    <%= number_with_precision(adx, precision: 1) %>
                  </span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td>
                <% st = candidate.dig(:indicators, :supertrend) || candidate.dig(:weekly_indicators, :supertrend) %>
                <% if st %>
                  <span class="badge bg-<%= st[:direction] == :bullish ? 'success' : 'danger' %>">
                    <%= st[:direction].to_s.upcase %>
                  </span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td>
                <% ema20 = candidate.dig(:indicators, :ema20) || candidate.dig(:daily_indicators, :ema20) %>
                <% ema50 = candidate.dig(:indicators, :ema50) || candidate.dig(:daily_indicators, :ema50) %>
                <% if ema20 && ema50 %>
                  <span class="badge bg-<%= ema20 > ema50 ? 'success' : 'danger' %>">
                    <%= ema20 > ema50 ? 'BULL' : 'BEAR' %>
                  </span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td>
                <% macd = candidate.dig(:indicators, :macd) || candidate.dig(:daily_indicators, :macd) %>
                <% if macd.is_a?(Array) && macd.size >= 2 %>
                  <% macd_line = macd[0] %>
                  <% signal_line = macd[1] %>
                  <span class="badge bg-<%= macd_line > signal_line ? 'success' : 'secondary' %>">
                    <%= macd_line > signal_line ? 'BULL' : 'BEAR' %>
                  </span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <% if candidate[:ai_score] || candidate[:ai_confidence] %>
                <td>
                  <% if candidate[:ai_score] %>
                    <span class="badge bg-<%= candidate[:ai_score] >= 80 ? 'success' : candidate[:ai_score] >= 60 ? 'warning' : 'secondary' %>">
                      <%= number_with_precision(candidate[:ai_score], precision: 1) %>
                    </span>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% if candidate[:ai_confidence] %>
                    <span class="badge bg-info">
                      <%= number_with_precision(candidate[:ai_confidence], precision: 1) %>
                    </span>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
              <% end %>
              <% if show_recommendation %>
                <td>
                  <% rec = candidate[:recommendation] || "N/A" %>
                  <% rec_class = case rec
                       when /Strong Buy|Buy/i then "success"
                       when /Watch/i then "warning"
                       when /Wait|Avoid/i then "danger"
                       when /Already in/i then "info"
                       else "secondary"
                     end %>
                  <span class="badge bg-<%= rec_class %>">
                    <%= rec %>
                  </span>
                </td>
              <% end %>
              <% if show_position && candidate[:position] %>
                <td>
                  <% pos = candidate[:position] %>
                  <% mode = candidate[:position_mode] || "unknown" %>
                  <span class="badge bg-<%= mode == 'live' ? 'danger' : 'info' %>">
                    <%= mode.upcase %>
                  </span>
                  <small class="text-muted d-block" style="font-size: 0.75rem; line-height: 1.2;">
                    Entry: ₹<%= number_with_precision(pos.entry_price, precision: 2) %>
                    <% if pos.respond_to?(:unrealized_pnl) %>
                      | P&L: <span class="<%= pos.unrealized_pnl >= 0 ? 'text-success' : 'text-danger' %>">
                        ₹<%= number_with_precision(pos.unrealized_pnl, precision: 0) %>
                      </span>
                    <% end %>
                  </small>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
