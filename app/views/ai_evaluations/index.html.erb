<% content_for :page_title, "AI Evaluations" %>

<p class="text-muted mb-3 small"><i class="bi bi-robot"></i> View AI-powered signal evaluations and rankings</p>

<!-- Filters -->
<div class="card mb-3">
  <div class="card-body p-2">
    <div class="row g-2">
      <div class="col-md-3">
        <label class="form-label">Trading Mode</label>
        <select class="form-select" id="mode-filter" onchange="filterAIEvaluations()">
          <option value="all" <%= 'selected' if @mode == 'all' %>>All Modes</option>
          <option value="live" <%= 'selected' if @mode == 'live' %>>Live</option>
          <option value="paper" <%= 'selected' if @mode == 'paper' %>>Paper</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Status</label>
        <select class="form-select" id="status-filter" onchange="filterAIEvaluations()">
          <option value="all" <%= 'selected' if @status == 'all' %>>All Status</option>
          <option value="executed" <%= 'selected' if @status == 'executed' %>>Executed</option>
          <option value="pending" <%= 'selected' if @status == 'pending' %>>Pending Approval</option>
          <option value="not_executed" <%= 'selected' if @status == 'not_executed' %>>Not Executed</option>
          <option value="failed" <%= 'selected' if @status == 'failed' %>>Failed</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">AI Data Only</label>
        <select class="form-select" id="ai-only-filter" onchange="filterAIEvaluations()">
          <option value="false" <%= 'selected' if params[:ai_only] != 'true' %>>Show All</option>
          <option value="true" <%= 'selected' if params[:ai_only] == 'true' %>>AI Evaluated Only</option>
        </select>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-primary w-100" onclick="filterAIEvaluations()">
          <i class="bi bi-funnel"></i> Apply Filters
        </button>
      </div>
    </div>
  </div>
</div>

<!-- AI Evaluations Table -->
<div class="card">
  <div class="card-body p-2">
    <% if @signals_with_ai&.any? %>
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
          <thead>
            <tr>
              <th>Symbol</th>
              <th>Direction</th>
              <th>Entry Price</th>
              <th>AI Score</th>
              <th>AI Confidence</th>
              <th>Timeframe Alignment</th>
              <th>Entry Timing</th>
              <th>AI Risk</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @signals_with_ai.each do |item| %>
              <% signal = item[:signal] %>
              <tr>
                <td><strong><%= signal.symbol %></strong></td>
                <td>
                  <span class="badge bg-<%= signal.long? ? 'success' : 'danger' %>">
                    <%= signal.direction.upcase %>
                  </span>
                </td>
                <td>â‚¹<%= number_with_precision(signal.entry_price, precision: 2) %></td>
                <td>
                  <% if item[:ai_score] %>
                    <span class="badge bg-<%= item[:ai_score] >= 80 ? 'success' : item[:ai_score] >= 60 ? 'warning' : 'secondary' %>">
                      <%= number_with_precision(item[:ai_score], precision: 1) %>/100
                    </span>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% if item[:ai_confidence] %>
                    <span class="badge bg-info">
                      <%= number_with_precision(item[:ai_confidence], precision: 1) %>/100
                    </span>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% if item[:timeframe_alignment] %>
                    <% alignment_class = case item[:timeframe_alignment].to_s.downcase
                         when 'excellent' then 'success'
                         when 'good' then 'info'
                         when 'fair' then 'warning'
                         else 'secondary'
                       end %>
                    <span class="badge bg-<%= alignment_class %>">
                      <%= item[:timeframe_alignment].to_s.humanize %>
                    </span>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% if item[:entry_timing] %>
                    <% timing_class = case item[:entry_timing].to_s.downcase
                         when 'optimal' then 'success'
                         when 'good' then 'info'
                         when 'fair' then 'warning'
                         else 'secondary'
                       end %>
                    <span class="badge bg-<%= timing_class %>">
                      <%= item[:entry_timing].to_s.humanize %>
                    </span>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% if item[:ai_risk] %>
                    <% risk_class = case item[:ai_risk].to_s.downcase
                         when 'low' then 'success'
                         when 'medium' then 'warning'
                         when 'high' then 'danger'
                         else 'secondary'
                       end %>
                    <span class="badge bg-<%= risk_class %>">
                      <%= item[:ai_risk].to_s.humanize %>
                    </span>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% if signal.executed? %>
                    <span class="badge bg-success">Executed</span>
                  <% elsif signal.pending_approval? %>
                    <span class="badge bg-warning">Pending</span>
                  <% elsif signal.failed? %>
                    <span class="badge bg-danger">Failed</span>
                  <% else %>
                    <span class="badge bg-secondary">Not Executed</span>
                  <% end %>
                </td>
                <td>
                  <button class="btn btn-sm btn-outline-primary"
                          onclick="showAIDetails('<%= signal.id %>')"
                          data-bs-toggle="modal"
                          data-bs-target="#aiDetailsModal">
                    <i class="bi bi-info-circle"></i> Details
                  </button>
                </td>
              </tr>
              <!-- Hidden row for AI summary -->
              <tr id="ai-summary-<%= signal.id %>" style="display: none;">
                <td colspan="10">
                  <div class="alert alert-info mb-0">
                    <strong>AI Summary:</strong>
                    <%= item[:ai_summary] || "No AI summary available" %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-robot" style="font-size: 3rem; color: #ccc;"></i>
        <p class="text-muted mt-3">No AI evaluations found</p>
        <p class="text-muted small">
          <% if params[:ai_only] == 'true' %>
            No signals with AI evaluation data found. Try removing the "AI Evaluated Only" filter.
          <% else %>
            AI evaluations will appear here when signals are evaluated by the AI system.
          <% end %>
        </p>
      </div>
    <% end %>
  </div>
</div>

<!-- AI Details Modal -->
<div class="modal fade" id="aiDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-robot"></i> AI Evaluation Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="aiDetailsContent">
        <!-- Content will be loaded dynamically -->
      </div>
    </div>
  </div>
</div>

<script>
function filterAIEvaluations() {
  const mode = document.getElementById('mode-filter').value;
  const status = document.getElementById('status-filter').value;
  const aiOnly = document.getElementById('ai-only-filter').value;

  const params = new URLSearchParams();
  if (mode !== 'all') params.append('mode', mode);
  if (status !== 'all') params.append('status', status);
  if (aiOnly === 'true') params.append('ai_only', 'true');

  window.location.href = '<%= ai_evaluations_path %>?' + params.toString();
}

function showAIDetails(signalId) {
  // Find the signal data
  const signalRow = document.querySelector(`tr:has(button[onclick*="${signalId}"])`);
  if (!signalRow) return;

  // Extract data from the row
  const cells = signalRow.querySelectorAll('td');
  const symbol = cells[0].textContent.trim();
  const direction = cells[1].textContent.trim();
  const entryPrice = cells[2].textContent.trim();
  const aiScore = cells[3].textContent.trim();
  const aiConfidence = cells[4].textContent.trim();
  const timeframeAlignment = cells[5].textContent.trim();
  const entryTiming = cells[6].textContent.trim();
  const aiRisk = cells[7].textContent.trim();

  // Get AI summary from hidden row
  const summaryRow = document.getElementById(`ai-summary-${signalId}`);
  const aiSummary = summaryRow ? summaryRow.querySelector('.alert').textContent.replace('AI Summary:', '').trim() : 'No summary available';

  // Build modal content
  const content = `
    <div class="row">
      <div class="col-md-6">
        <h6>Signal Information</h6>
        <table class="table table-sm">
          <tr><td><strong>Symbol:</strong></td><td>${symbol}</td></tr>
          <tr><td><strong>Direction:</strong></td><td>${direction}</td></tr>
          <tr><td><strong>Entry Price:</strong></td><td>${entryPrice}</td></tr>
        </table>
      </div>
      <div class="col-md-6">
        <h6>AI Evaluation</h6>
        <table class="table table-sm">
          <tr><td><strong>AI Score:</strong></td><td>${aiScore}</td></tr>
          <tr><td><strong>AI Confidence:</strong></td><td>${aiConfidence}</td></tr>
          <tr><td><strong>Timeframe Alignment:</strong></td><td>${timeframeAlignment}</td></tr>
          <tr><td><strong>Entry Timing:</strong></td><td>${entryTiming}</td></tr>
          <tr><td><strong>AI Risk:</strong></td><td>${aiRisk}</td></tr>
        </table>
      </div>
    </div>
    <div class="mt-3">
      <h6>AI Summary</h6>
      <p class="text-muted">${aiSummary}</p>
    </div>
  `;

  document.getElementById('aiDetailsContent').innerHTML = content;
}
</script>
